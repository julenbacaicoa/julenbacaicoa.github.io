<!-- start custom footer snippets -->

<!-- Supabase JS loader con fallbacks + Promise global + EVENTO -->
<script>
  (function () {
    function fireReady(sb) {
      try { document.dispatchEvent(new CustomEvent('supabase:ready', { detail: sb })); } catch (e) {}
    }
    window.__supabaseReady = new Promise(function (resolve) {
      function init() {
        try {
          if (!window.__supabase) {
            window.__supabase = supabase.createClient(
              '{{ site.supabase_url }}',
              '{{ site.supabase_anon_key }}'
            );
          }
          resolve(window.__supabase);
          fireReady(window.__supabase);
        } catch (e) { console.error('Supabase init error:', e); }
      }
      function inject(src, onload) {
        var s = document.createElement('script');
        s.src = src; s.crossOrigin = 'anonymous'; s.referrerPolicy = 'no-referrer';
        s.onload = onload;
        s.onerror = function () {
          if (src.includes('jsdelivr')) inject('https://unpkg.com/@supabase/supabase-js@2', init);
          else if (src.includes('unpkg')) inject('https://cdn.skypack.dev/@supabase/supabase-js@2', init);
          else console.error('No se pudo cargar @supabase/supabase-js');
        };
        document.head.appendChild(s);
      }
      if (window.supabase) init();
      else inject('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2', init);
    });

    /* Slug canónico compartido */
    window.__canonicalSlug = function (pathname) {
      const BASE = '{{ site.baseurl | default: "" }}';
      let s = pathname || "/";
      if (BASE && s.startsWith(BASE)) s = s.slice(BASE.length);
      if (!s.startsWith("/")) s = "/" + s;
      s = s.replace(/\/index\.html$/i, "/").replace(/\/{2,}/g, "/");
      if (s !== "/" && !s.endsWith("/")) s += "/";
      return s.toLowerCase();
    };
  })();
</script>

<!-- Code enhanced -->
<script src="{{ '/assets/js/code-enhancer.js' | relative_url }}"></script>

<!-- Code header -->
<script src="{{ '/assets/js/code-header.js' | relative_url }}"></script>

<!-- Post views: incrementa SOLO en posts (detecta meta x-is-post) -->
<script>
  (function () {
    const isPost = document.querySelector('meta[name="x-is-post"][content="1"]');
    if (!isPost) return; // no cuentes en home, blog, páginas...

    // Slug desde meta (si existe) o desde la URL actual; normalizado
    const raw = (document.querySelector('meta[name="x-post-slug"]') || {}).content || window.location.pathname;
    const slug = window.__canonicalSlug(raw);

    // Evita duplicar en la misma pestaña/ventana
    const KEY = 'srv_viewed_' + slug;
    if (!sessionStorage.getItem(KEY)) {
      sessionStorage.setItem(KEY, '1');
      window.__supabaseReady.then(sb => {
        sb.rpc('inc_view', { p_slug: slug })
          .catch(() => { /* silenciar errores de red/RPC */ });
      });
    }
  })();
</script>

<!-- end custom footer snippets -->
