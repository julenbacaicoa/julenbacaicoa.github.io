<!-- start custom footer snippets -->

<!-- Supabase JS loader + Promise global + evento -->
<script>
  (function () {
    function fireReady(sb) {
      try { document.dispatchEvent(new CustomEvent('supabase:ready', { detail: sb })); } catch {}
    }
    window.__supabaseReady = new Promise(function (resolve) {
      function init() {
        try {
          if (!window.__supabase) {
            window.__supabase = supabase.createClient(
              '{{ site.supabase_url }}',
              '{{ site.supabase_anon_key }}'
            );
          }
          resolve(window.__supabase);
          fireReady(window.__supabase);
        } catch (e) { console.error('Supabase init error:', e); }
      }
      function inject(src, onload) {
        var s = document.createElement('script');
        s.src = src; s.crossOrigin = 'anonymous'; s.referrerPolicy = 'no-referrer';
        s.onload = onload;
        s.onerror = function () {
          if (src.includes('jsdelivr')) inject('https://unpkg.com/@supabase/supabase-js@2', init);
          else if (src.includes('unpkg')) inject('https://cdn.skypack.dev/@supabase/supabase-js@2', init);
          else console.error('No se pudo cargar @supabase/supabase-js');
        };
        document.head.appendChild(s);
      }
      if (window.supabase) init();
      else inject('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2', init);
    });

    /* Slug canónico robusto (global) */
    window.__canonicalSlug = function (pathname) {
      let s;
      try { s = new URL(pathname || '/', location.origin).pathname; }
      catch { s = pathname || '/'; }
      s = s.replace(/\/index\.html$/i,'/').replace(/\/{2,}/g,'/');
      if (s !== '/' && !s.endsWith('/')) s += '/';
      return s.toLowerCase();
    };
  })();
</script>

<!-- Code enhanced -->
<script src="{{ '/assets/js/code-enhancer.js' | relative_url }}"></script>

<!-- Code header -->
<script src="{{ '/assets/js/code-header.js' | relative_url }}"></script>

<!-- Post views: cuenta vistas en páginas con x-track-views; SDK + REST + reintento; con anti-doble -->
<script>
  (function () {
    const DEBUG = /[?&]debug=views\b/.test(location.search);

    const isTrack = document.querySelector('meta[name="x-track-views"][content="1"]')
                   || document.body.classList.contains('layout--single');
    if (!isTrack) return;

    // Debug badge
    let badge;
    function say(msg) {
      if (!DEBUG) return;
      console.log('[views]', msg);
      if (!badge) {
        badge = document.createElement('div');
        badge.style = 'position:fixed;bottom:12px;right:12px;background:#111;color:#0f0;padding:8px 10px;border-radius:8px;font:12px/1.2 monospace;z-index:99999;opacity:.9';
        document.body.appendChild(badge);
      }
      badge.textContent = String(msg);
    }

    const raw  = (document.querySelector('meta[name="x-post-slug"]') || {}).content || location.pathname;
    const slug = window.__canonicalSlug ? window.__canonicalSlug(raw) : raw;

    // Evita duplicar en la misma pestaña (solo marcamos TRAS éxito)
    const SESSION_KEY = 'srv_viewed_' + slug;
    if (sessionStorage.getItem(SESSION_KEY)) { say('ya contado esta pestaña'); return; }

    // === Candados anti-doble (misma carga de página) ===
    let started  = false;   // ya hemos iniciado un bump
    let finished = false;   // bump completado con éxito

    const SB_URL = '{{ site.supabase_url }}'.replace(/\/+$/, '');
    const SB_KEY = '{{ site.supabase_anon_key }}';

    async function bumpViaSDK(ms) {
      try {
        say('SDK…');
        const ready = window.__supabase ? Promise.resolve(window.__supabase)
                    : (window.__supabaseReady && window.__supabaseReady);
        if (!ready) return false;
        const sb = await Promise.race([
          ready,
          new Promise((_, r) => setTimeout(() => r(new Error('sdk-timeout')), ms || 1600))
        ]);
        if (!sb || typeof sb.rpc !== 'function') return false;
        const { error } = await sb.rpc('inc_view', { p_slug: slug });
        if (error) { say('SDK error'); return false; }
        say('SDK OK');
        return true;
      } catch { return false; }
    }

    async function bumpViaREST() {
      try {
        say('REST…');
        const res = await fetch(SB_URL + '/rest/v1/rpc/inc_view', {
          method: 'POST',
          headers: {
            'content-type': 'application/json',
            'apikey': SB_KEY,
            'authorization': 'Bearer ' + SB_KEY
          },
          body: JSON.stringify({ p_slug: slug })
        });
        say('REST status ' + res.status);
        return res.ok;
      } catch { return false; }
    }

    function afterSuccess() {
      finished = true;                  // marca que ya hicimos un bump válido
      sessionStorage.setItem(SESSION_KEY, '1');
      say('SUCCESS');
    }

    async function tryBump() {
      // ← candado: impide que se inicien dos intentos en paralelo
      if (started || finished) return;
      started = true;

      say('slug ' + slug);
      let ok = await bumpViaSDK(1600);
      if (!ok) ok = await bumpViaREST();

      if (!ok) {
        say('reintento en ~2.2s…');
        setTimeout(async () => {
          if (finished) return;         // si ya se consiguió por otro camino, no repitas
          let ok2 = await bumpViaSDK(1600);
          if (!ok2) ok2 = await bumpViaREST();
          if (ok2) afterSuccess();
        }, 2200);
      } else {
        afterSuccess();
      }
    }

    // Disparo inicial
    tryBump();

    // Si el SDK llega tarde, reintenta UNA vez — protegido por los candados
    document.addEventListener('supabase:ready', () => {
      if (!finished) tryBump();
    }, { once: true });

    // Helper de depuración: window.bumpView('/misc/welcome/')
    window.bumpView = async function (s) {
      const target = (window.__canonicalSlug ? window.__canonicalSlug(s || slug) : (s || slug));
      const res = await fetch(SB_URL + '/rest/v1/rpc/inc_view', {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
          'apikey': SB_KEY,
          'authorization': 'Bearer ' + SB_KEY
        },
        body: JSON.stringify({ p_slug: target })
      });
      const txt = await res.text().catch(()=> '');
      console.log('bumpView', target, res.status, txt);
      return res.status;
    };
  })();
</script>


<!-- end custom footer snippets -->
