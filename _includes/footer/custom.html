<!-- start custom footer snippets -->

<!-- Supabase JS loader con fallbacks + Promise global + EVENTO -->
<script>
  (function () {
    function fireReady(sb) {
      try { document.dispatchEvent(new CustomEvent('supabase:ready', { detail: sb })); } catch (e) {}
    }
    window.__supabaseReady = new Promise(function (resolve) {
      function init() {
        try {
          if (!window.__supabase) {
            window.__supabase = supabase.createClient(
              '{{ site.supabase_url }}',
              '{{ site.supabase_anon_key }}'
            );
          }
          resolve(window.__supabase);
          fireReady(window.__supabase);
        } catch (e) { console.error('Supabase init error:', e); }
      }
      function inject(src, onload) {
        var s = document.createElement('script');
        s.src = src; s.crossOrigin = 'anonymous'; s.referrerPolicy = 'no-referrer';
        s.onload = onload;
        s.onerror = function () {
          if (src.includes('jsdelivr')) inject('https://unpkg.com/@supabase/supabase-js@2', init);
          else if (src.includes('unpkg')) inject('https://cdn.skypack.dev/@supabase/supabase-js@2', init);
          else console.error('No se pudo cargar @supabase/supabase-js');
        };
        document.head.appendChild(s);
      }
      if (window.supabase) init();
      else inject('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2', init);
    });

    /* Slug canónico compartido */
    window.__canonicalSlug = function (pathname) {
      const BASE = '{{ site.baseurl | default: "" }}';
      let s = pathname || "/";
      if (BASE && s.startsWith(BASE)) s = s.slice(BASE.length);
      if (!s.startsWith("/")) s = "/" + s;
      s = s.replace(/\/index\.html$/i, "/").replace(/\/{2,}/g, "/");
      if (s !== "/" && !s.endsWith("/")) s += "/";
      return s.toLowerCase();
    };
  })();
</script>

<!-- Code enhanced -->
<script src="{{ '/assets/js/code-enhancer.js' | relative_url }}"></script>

<!-- Code header -->
<script src="{{ '/assets/js/code-header.js' | relative_url }}"></script>

<!-- Post views: incrementa en páginas con x-track-views; ahora solo marca la sesión si el bump tuvo éxito -->
<script>
  (function () {
    // 1) ¿Esta página debe contar?
    const isTrack = document.querySelector('meta[name="x-track-views"][content="1"]')
                   || document.body.classList.contains('layout--single'); // fallback por si falta el meta
    if (!isTrack) return;

    // 2) Slug canónico (igual que en Home/Blog)
    const BASE = '{{ site.baseurl | default: "" }}';
    function canonicalSlug(pathname) {
      let s = pathname || "/";
      if (BASE && s.startsWith(BASE)) s = s.slice(BASE.length);
      if (!s.startsWith("/")) s = "/" + s;
      s = s.replace(/\/index\.html$/i, "/").replace(/\/{2,}/g, "/");
      if (s !== "/" && !s.endsWith("/")) s += "/";
      return s.toLowerCase();
    }
    const raw = (document.querySelector('meta[name="x-post-slug"]') || {}).content || window.location.pathname;
    const slug = canonicalSlug(raw);

    // 3) Llaves de control
    const SESSION_KEY = 'srv_viewed_' + slug;          // evita duplicar en la misma pestaña
    const TTL_KEY     = 'srv_viewed_ts_' + slug;       // opcional: TTL por dispositivo
    const TTL_MS      = 0;                              // 0 = desactivado (si quieres 24h: 24*60*60*1000)

    // Si tienes TTL, respétalo (no sumar otra vista hasta que caduque)
    if (TTL_MS > 0) {
      const ts = parseInt(localStorage.getItem(TTL_KEY) || '0', 10);
      if (ts && (Date.now() - ts) < TTL_MS) return;
    }

    // Si ya contamos en esta pestaña, no repitas
    if (sessionStorage.getItem(SESSION_KEY)) return;

    // 4) Dos caminos para “bump”: SDK (cuando esté) o REST directo. Solo marcamos la sesión si alguno tiene éxito.
    const SB_URL = '{{ site.supabase_url }}'.replace(/\/+$/, '');
    const SB_KEY = '{{ site.supabase_anon_key }}';

    async function bumpViaSDK(timeoutMs) {
      try {
        const ready = window.__supabase
          ? Promise.resolve(window.__supabase)
          : (window.__supabaseReady && window.__supabaseReady);

        if (!ready) return false;

        // timeout suave por si el SDK tarda
        const sb = await Promise.race([
          ready,
          new Promise((_, rej) => setTimeout(() => rej(new Error('sdk-timeout')), timeoutMs || 1800))
        ]);
        if (!sb || typeof sb.rpc !== 'function') return false;

        const { error } = await sb.rpc('inc_view', { p_slug: slug });
        return !error;
      } catch (_) {
        return false;
      }
    }

    async function bumpViaREST() {
      try {
        const res = await fetch(SB_URL + '/rest/v1/rpc/inc_view', {
          method: 'POST',
          headers: {
            'content-type': 'application/json',
            'apikey': SB_KEY,
            'authorization': 'Bearer ' + SB_KEY
          },
          body: JSON.stringify({ p_slug: slug })
        });
        return res.ok;
      } catch (_) {
        return false;
      }
    }

    async function tryBump() {
      // Primero intentamos SDK con timeout corto; si no, REST; si aún falla, reintento tardío.
      let ok = await bumpViaSDK(1800);
      if (!ok) ok = await bumpViaREST();

      if (!ok) {
        setTimeout(async () => {
          let ok2 = await bumpViaSDK(1800);
          if (!ok2) ok2 = await bumpViaREST();
          if (ok2) afterSuccess();
        }, 2500);
      } else {
        afterSuccess();
      }
    }

    function afterSuccess() {
      sessionStorage.setItem(SESSION_KEY, '1');       // ¡ahora sí! solo si el bump ha funcionado
      if (TTL_MS > 0) localStorage.setItem(TTL_KEY, String(Date.now()));
    }

    tryBump();

    // Por si el SDK llega muy tarde y arriba todo falló, escuchamos el evento y volvemos a intentar 1 vez.
    document.addEventListener('supabase:ready', () => { if (!sessionStorage.getItem(SESSION_KEY)) tryBump(); }, { once: true });

    // Utilidad de depuración (opcional): window.bumpView('/misc/welcome/')
    window.bumpView = async function (s) {
      const target = s ? canonicalSlug(s) : slug;
      const res = await fetch(SB_URL + '/rest/v1/rpc/inc_view', {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
          'apikey': SB_KEY,
          'authorization': 'Bearer ' + SB_KEY
        },
        body: JSON.stringify({ p_slug: target })
      });
      console.log('bumpView', target, res.status, await res.text().catch(()=>'')); // ver consola
    };
  })();
</script>

<!-- end custom footer snippets -->
